{% extends 'base.html.twig' %}

{% block title %}{{ post.title }}{% endblock %}

{% block body %}
<section class="layout-pt-md layout-pb-md">
  <div class="container">
    <div class="row y-gap-40">
      <div class="col-lg-8">
        <div class="blog-single">
          {% if post.picture %}
            <div class="blog-single__img mb-40">
              <img src="{{ asset('uploads/posts/' ~ post.picture) }}" alt="{{ post.title }}" class="rounded-8 w-100">
            </div>
          {% endif %}

          <div class="d-flex items-center">
            <div class="size-40 rounded-full bg-blue-1">
              <img src="{{ asset('html/img/avatars/3.png') }}" alt="avatar" class="size-40 rounded-full object-cover">
            </div>
            <div class="text-14 ml-10">by <a href="#" class="fw-500 text-blue-1">{{ author.name }} {{ author.lastname }}</a></div>
            <div class="text-14 ml-10">{{ post.date|date('M d, Y') }}</div>
            <div class="text-14 ml-10"><i class="icon-tag mr-5"></i>{{ activity.activityName }}</div>
          </div>

          <h1 class="text-30 fw-600 mt-20">{{ post.title }}</h1>
          
          {% if isAuthor %}
          <div class="d-flex x-gap-10 mt-20">
            <a href="{{ path('app_blog_edit', {'id': post.id}) }}" class="button -sm -blue-1 bg-blue-1-05 text-blue-1">
              <i class="icon-edit mr-10"></i> Edit Post
            </a>
            <a href="{{ path('app_blog_delete', {'id': post.id}) }}" class="button -sm -red-1 bg-red-1-05 text-red-1" onclick="return confirm('Are you sure you want to delete this post?')">
              <i class="icon-trash mr-10"></i> Delete Post
            </a>
          </div>
          {% endif %}

          <div class="blog-single__content mt-40">
            {{ post.description|raw }}
          </div>

          <div class="border-top-light mt-30 mb-30"></div>

          <div class="row y-gap-20 justify-between pt-30">
            <div class="col-auto">
              <div class="d-flex items-center">
                <div class="fw-500 mr-10">Share</div>

                <div class="d-flex x-gap-15">
                  <a href="#" class="text-14"><i class="icon-facebook"></i></a>
                  <a href="#" class="text-14"><i class="icon-twitter"></i></a>
                  <a href="#" class="text-14"><i class="icon-instagram"></i></a>
                  <a href="#" class="text-14"><i class="icon-linkedin"></i></a>
                </div>
              </div>
            </div>

            {% if app.user and (app.user.id == post.userId or app.user.role == 'Admin') %}
              <div class="col-auto">
                <div class="row x-gap-10 y-gap-10">
                  <div class="col-auto">
                    <a href="{{ path('app_post_edit', {'id': post.id}) }}" class="button -blue-1 py-10 px-20 bg-blue-1-05 text-15 text-blue-1">
                      <i class="icon-edit mr-10"></i> Edit
                    </a>
                  </div>
                  <div class="col-auto">
                    <a href="{{ path('app_post_delete', {'id': post.id}) }}" class="button -red-1 py-10 px-20 bg-red-1-05 text-15 text-red-1" onclick="return confirm('Are you sure you want to delete this post?')">
                      <i class="icon-trash mr-10"></i> Delete
                    </a>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>

          <div class="border-top-light mt-30 mb-30"></div>

          <!-- Comments Section -->
          <div class="row">
            <div class="col-12">
              <h2 class="text-22 fw-500 mb-15">Comments <span class="text-15 text-light-1">({{ comments|length }})</span></h2>

              {% if comments is empty %}
                <div class="py-30 px-20 rounded-4 bg-light-2 mt-20">
                  <i class="icon-comment text-30 text-blue-1"></i>
                  <h4 class="text-18 fw-500 mt-10">No comments yet</h4>
                  <p class="mt-5">Be the first to comment on this post</p>
                </div>
              {% else %}
                <div class="comments mt-30">
                  {% for comment in comments %}
                    <div class="comment-item bg-white mb-20 py-20 px-30 rounded-8">
                      <div class="row x-gap-20 y-gap-20 items-center">
                        <div class="col-auto">
                          <div class="comment-item__image size-70 rounded-full">
                            <img src="img/avatars/user.png" alt="User" class="size-70 rounded-full">
                          </div>
                        </div>
                        <div class="col-md">
                          <div class="comment-item__header">
                            <div class="text-17 fw-500 lh-15">{{ commentUsers[comment.userId].name }} {{ commentUsers[comment.userId].lastname }}</div>
                            <div class="text-14 text-light-1 mt-5">{{ comment.date|date('M d, Y H:i') }}</div>
                          </div>
                          <div class="comment-item__text mt-10">
                            <p>{{ comment.comment }}</p>
                          </div>
                          
                          {% if app.user and comment.userId == app.user.id %}
                          <div class="d-flex x-gap-10 mt-10">
                            <button type="button" class="text-14 text-blue-1" data-bs-toggle="modal" data-bs-target="#editComment{{ comment.id }}">
                              <i class="icon-edit mr-5"></i> Edit
                            </button>
                            <a href="{{ path('app_blog_comment_delete', {'id': comment.id}) }}" class="text-14 text-red-1" onclick="return confirm('Are you sure you want to delete this comment?')">
                              <i class="icon-trash mr-5"></i> Delete
                            </a>
                          </div>
                          
                          <!-- Edit Comment Modal -->
                          <div class="modal fade" id="editComment{{ comment.id }}" tabindex="-1" aria-labelledby="editCommentLabel{{ comment.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title" id="editCommentLabel{{ comment.id }}">Edit Comment</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form action="{{ path('app_blog_comment_edit', {'id': comment.id}) }}" method="post">
                                  <div class="modal-body">
                                    <div class="form-group">
                                      <textarea name="comment" class="form-control" rows="4" required>{{ comment.comment }}</textarea>
                                    </div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="button -blue-1 bg-blue-1-05 text-blue-1" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="button -dark-1 bg-blue-1 text-white">Save changes</button>
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Comment Form -->
              {% if app.user %}
                <div class="comment-form mt-40">
                  <h3 class="text-20 fw-500 mb-20">Leave a Comment</h3>
                  <form action="{{ path('app_blog_comment_add', {'postId': post.id}) }}" method="post">
                    <div class="mb-20">
                      <textarea name="comment" class="form-control py-20 px-30 rounded-4" rows="5" placeholder="Your comment here..." required></textarea>
                    </div>
                    <div class="row">
                      <div class="col-auto">
                        <button type="submit" class="button -md -dark-1 bg-blue-1 text-white">
                          Submit Comment <i class="icon-arrow-right ml-10"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              {% else %}
                <div class="mt-40 py-20 px-30 rounded-4 bg-light-2 text-center">
                  <h4 class="text-16 fw-500">Please <a href="{{ path('app_login') }}" class="text-blue-1">log in</a> to leave a comment</h4>
                </div>
              {% endif %}
            </div>
          </div>
          <!-- End Comments Section -->
        </div>
      </div>

      <div class="col-lg-4">
        <div class="d-flex justify-between items-center">
          <h2 class="text-22 fw-500">Related Posts</h2>
        </div>

        <div class="row y-gap-30 pt-30">
          <!-- You can implement related posts logic here -->
          <div class="col-12">
            <a href="{{ path('app_blog_index') }}" class="button -md -outline-blue-1 text-blue-1 w-100">
              View All Posts <i class="icon-arrow-right ml-10"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}