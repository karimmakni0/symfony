{% extends 'base.html.twig' %}

{% block title %}{{ activity.activityName }} - Activity Details{% endblock %}

{% block body %}
{# --- HERO IMAGE / GALLERY --- #}
<div class="container-fluid p-0 mb-5">
  {% if activity.resources is not empty %}
    <div id="activityHeroCarousel" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner">
        {% for resource in activity.resources %}
          <div class="carousel-item {% if loop.first %}active{% endif %}">
            <img src="{{ asset(resource.path) }}" class="d-block w-100" style="max-height:420px;object-fit:cover;" alt="{{ activity.activityName }}">
          </div>
        {% endfor %}
      </div>
      {% if activity.resources|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#activityHeroCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#activityHeroCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      {% endif %}
    </div>
  {% else %}
    <img src="{{ asset('assets/img/activities/default.jpg') }}" class="d-block w-100" style="max-height:420px;object-fit:cover;" alt="{{ activity.activityName }}">
  {% endif %}
</div>

{# --- MAIN CONTENT --- #}
<div class="container">
  <div class="row g-5">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 rounded-4 p-4 mb-4 bg-white">
        <h2 class="text-primary mb-3">{{ activity.activityName }}</h2>
        <p class="lead mb-2"><strong>Destination:</strong> {{ activity.activityDestination }}</p>
        <p class="mb-2"><strong>Description:</strong> {{ activity.activityDescription|raw }}</p>
        <p class="mb-2"><strong>Duration:</strong> {{ activity.activityDuration ?? 'N/A' }}</p>
        <p class="mb-2"><strong>Price:</strong> <span class="text-success">{{ activity.activityPrice }} TND</span></p>
      </div>
      <div class="card shadow-sm border-0 rounded-4 p-4 mb-4 bg-white">
        <h5 class="mb-3">About this activity</h5>
        <div>{{ activity.activityDescription|raw }}</div>
        <hr>
        <h6 class="mb-2">Activity Details</h6>
        <ul class="list-unstyled mb-3">
          <li><i class="fa fa-calendar text-primary me-2"></i> <strong>Date:</strong> {{ activity.activityDate|date('d M Y') }}</li>
          <li><i class="fa fa-clock text-primary me-2"></i> <strong>Duration:</strong> {{ activity.activityDuration ?? 'N/A' }}</li>
          <li><i class="fa fa-tag text-primary me-2"></i> <strong>Type:</strong> {{ activity.activityType ?? 'N/A' }}</li>
          <li><i class="fa fa-map-marker-alt text-primary me-2"></i> <strong>Location:</strong> {{ activity.activityDestination }}</li>
        </ul>
        <h6 class="mb-2">Availability Information</h6>
        <ul class="list-unstyled">
          <li><strong>Maximum capacity:</strong> {{ activity.maxNumber }}</li>
          <li><strong>Booked tickets:</strong> {{ totalBookedTickets }}</li>
          <li><strong>Remaining tickets:</strong> {{ activity.maxNumber - totalBookedTickets }}</li>
        </ul>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-lg border-0 rounded-4 p-4 mb-4 bg-white sticky-top" style="top: 90px;">
        <h5 class="mb-3">Book this activity</h5>
        <div class="mb-3 p-3 border rounded bg-light">
          <div class="d-flex justify-content-between mb-2">
            <span>Price per ticket:</span>
            <span class="fw-bold">{{ activity.activityPrice|number_format(2) }} TND</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Number of tickets:</span>
            <span id="summaryTicketCount">1</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Total price:</span>
            <span class="fw-bold" id="summaryTotalPrice">{{ activity.activityPrice|number_format(2) }} TND</span>
          </div>
        </div>
        <form action="{{ path('app_payment_reservation', {'id': activity.id}) }}" method="post">
          <div class="input-group mb-3">
            <span class="input-group-text">Number of participants</span>
            <button class="btn btn-outline-primary" type="button" id="decreaseParticipants">-</button>
            <input type="number" name="participants" id="directParticipantsInput" class="form-control text-center" value="1" min="1" max="{{ activity.maxNumber - totalBookedTickets }}">
            <button class="btn btn-outline-primary" type="button" id="increaseParticipants">+</button>
          </div>
          <input type="hidden" name="totalPrice" id="hiddenTotalPrice" value="{{ activity.activityPrice|number_format(2) }}">
          <button type="submit" class="btn btn-primary w-100">Book Now</button>
        </form>
        <small class="text-muted d-block mt-2">Not sure? You can cancel this reservation up to 24 hours in advance for a full refund.</small>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const participantsInput = document.getElementById('directParticipantsInput');
    const summaryTicketCount = document.getElementById('summaryTicketCount');
    const summaryTotalPrice = document.getElementById('summaryTotalPrice');
    const hiddenTotalPrice = document.getElementById('hiddenTotalPrice');
    const activityPrice = {{ activity.activityPrice|default(0) }};
    const maxTickets = {{ activity.maxNumber - totalBookedTickets }};
    let count = 1;
    document.getElementById('increaseParticipants').addEventListener('click', function() {
      if (count < maxTickets) {
        count++;
        participantsInput.value = count;
        summaryTicketCount.textContent = count;
        summaryTotalPrice.textContent = (count * activityPrice).toFixed(2) + ' TND';
        hiddenTotalPrice.value = (count * activityPrice).toFixed(2);
      }
    });
    document.getElementById('decreaseParticipants').addEventListener('click', function() {
      if (count > 1) {
        count--;
        participantsInput.value = count;
        summaryTicketCount.textContent = count;
        summaryTotalPrice.textContent = (count * activityPrice).toFixed(2) + ' TND';
        hiddenTotalPrice.value = (count * activityPrice).toFixed(2);
      }
    });
    participantsInput.addEventListener('input', function() {
      let val = parseInt(participantsInput.value);
      if (isNaN(val) || val < 1) val = 1;
      if (val > maxTickets) val = maxTickets;
      count = val;
      participantsInput.value = count;
      summaryTicketCount.textContent = count;
      summaryTotalPrice.textContent = (count * activityPrice).toFixed(2) + ' TND';
      hiddenTotalPrice.value = (count * activityPrice).toFixed(2);
    });
  });
</script>

<section class="pt-40">
  <div class="container">
    <div class="row y-gap-30 justify-between">
      <div class="col-lg-4">
        <h2 class="text-22 fw-500">Activity Location</h2>
        <div class="mt-25">
          <div class="text-15 fw-500">{{ activity.activityDestination }}</div>
          <div class="text-15 mt-5">Tunisia</div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="map-ratio rounded-4 overflow-hidden bg-blue-1-05 h-full">
          <div class="px-30 py-30 text-center">
            <div class="text-18 fw-500">Location map coming soon...</div>
            <p class="text-14 mt-5">This activity takes place in {{ activity.activityDestination }}, Tunisia.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="pt-40">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h3 class="text-22 fw-500 mb-20">Similar Activities</h3>
      </div>
    </div>

    <div class="row y-gap-30">
      <div class="col-xl-12">
        <div class="overflow-hidden js-section-slider" data-gap="30" data-slider-cols="xl-4 lg-3 md-2 sm-2 base-1">
          <div class="swiper-wrapper">
            {% for i in 1..4 %}
              <div class="swiper-slide">
                <div class="activityCard -type-1 rounded-4 hover-shadow-1">
                  <div class="activityCard__image">
                    <div class="cardImage ratio ratio-1:1">
                      <div class="cardImage__content">
                        <img class="rounded-4 col-12" src="{{ asset('assets/img/activities/1.png') }}" alt="image">
                      </div>
                      <div class="cardImage__wishlist">
                        <button class="button -blue-1 bg-white size-30 rounded-full shadow-2">
                          <i class="icon-heart text-12"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="activityCard__content mt-10">
                    <div class="text-14 lh-14 text-light-1 mb-5">6+ hours</div>
                    <h4 class="activityCard__title lh-16 fw-500 text-dark-1 text-18">
                      <span>Similar Activity {{ i }}</span>
                    </h4>
                    <p class="text-light-1 text-14 lh-14 mt-5">Tunisia</p>
                    <div class="row justify-between items-center pt-10">
                      <div class="col-auto">
                        <div class="d-flex items-center">
                          <div class="d-flex x-gap-5 items-center">
                            <i class="icon-star text-10 text-yellow-1"></i>
                            <i class="icon-star text-10 text-yellow-1"></i>
                            <i class="icon-star text-10 text-yellow-1"></i>
                            <i class="icon-star text-10 text-yellow-1"></i>
                            <i class="icon-star text-10 text-yellow-1"></i>
                          </div>
                          <div class="text-14 text-light-1 ml-10">4.8 (12)</div>
                        </div>
                      </div>
                      <div class="col-auto">
                        <div class="text-14 text-light-1">
                          From <span class="text-16 fw-500 text-dark-1">{{ activity.activityPrice ?? 150 }} TND</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block stylesheets %}
<style>
  .activity-carousel {
    max-height: 500px;
    overflow: hidden;
  }
  
  .activity-carousel .carousel-item img {
    width: 100%;
    height: 500px;
    object-fit: cover;
    object-position: center;
    cursor: pointer;
  }
  
  .activity-image-container {
    width: 100%;
    height: auto;
    max-height: 500px;
    overflow: hidden;
    position: relative;
  }
  
  .activity-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .activity-modal-image {
    width: 100%;
    height: auto;
    max-height: 80vh;
    object-fit: contain;
  }
  
  @media (max-width: 767px) {
    .activity-carousel,
    .activity-carousel .carousel-item img,
    .activity-image-container {
      height: 300px;
    }
  }
</style>
{% endblock %}

{% block javascripts %}
<!-- Add empty dummy elements to avoid JS errors -->
<div class="js-form-dd" style="display:none;">
  <div data-x-dd-click="empty"></div>
  <div data-x-dd="empty" data-x-dd-toggle="active"></div>
</div>

<div id="activityData" 
     data-max-number="{{ activity.maxNumber|default(0) }}" 
     data-booked-tickets="{{ totalBookedTickets|default(0) }}"
     data-price="{{ activity.activityPrice|default(0) }}"
     style="display: none;"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Update participant count when +/- buttons are clicked
    const participantsCount = document.getElementById('participantsCount');
    const participantsInput = document.getElementById('directParticipantsInput');
    const summaryTicketCount = document.getElementById('summaryTicketCount');
    const summaryTotalPrice = document.getElementById('summaryTotalPrice');
    
    // Get activity data from data attributes
    const activityData = document.getElementById('activityData');
    const activityPrice = parseFloat(activityData.dataset.price || 0);
    const maxNumber = parseInt(activityData.dataset.maxNumber || 0);
    const bookedTickets = parseInt(activityData.dataset.bookedTickets || 0);
    const remainingTickets = maxNumber - bookedTickets;
    
    // Initialize the count based on existing selection if any
    let count = parseInt(participantsCount.textContent) || 1;
    participantsInput.value = count;
    
    function updateSummary() {
      summaryTicketCount.textContent = count;
      const totalPrice = (count * activityPrice).toFixed(2);
      summaryTotalPrice.textContent = totalPrice + ' TND';
    }
    
    // Increase participants
    document.getElementById('increaseParticipants').addEventListener('click', function() {
      if (count < remainingTickets) {
        count++;
        participantsCount.textContent = count;
        participantsInput.value = count;
        updateSummary();
      }
    });
    
    // Decrease participants
    document.getElementById('decreaseParticipants').addEventListener('click', function() {
      if (count > 1) {
        count--;
        participantsCount.textContent = count;
        participantsInput.value = count;
        updateSummary();
      }
    });
    
    // Initialize summary
    updateSummary();
  });
</script>

<style>
.img-cover {
  object-fit: cover;
  width: 100%;
  height: 100%;
}

.activity-description {
  line-height: 1.8;
}

.activity-description p {
  margin-bottom: 1rem;
}

.activity-description img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1rem 0;
}
</style>
{% endblock %}